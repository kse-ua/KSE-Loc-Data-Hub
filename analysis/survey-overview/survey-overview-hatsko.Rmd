---
title: "Resilience Survey Overview"
author: 
- "Valentyn Hatsko"
- "Andriy Koval"  
date: "Last updated: `r Sys.Date()`"
output:
  html_document:
    keep_md: yes
    toc: yes
    toc_float: yes
    code_folding: show
    theme: cerulean
    highlight: zenburn
editor_options: 
  chunk_output_type: console
---

> This report visualizes key information about Resilience Survey

***Important Definitions***

> Research Sample: Hromadas who responded to the survey.

<!--  Set the working directory to the repository's base directory; this assumes the report is nested inside of two directories.-->

```{r, echo=F, message=F}
# cat("Working directory: ", getwd())
library(knitr)
opts_knit$set(root.dir='../../')  #Don't combine this call with any other chunk -especially one that uses file paths.
```

```{r set_options, echo=F, message=FALSE, warning=FALSE, results = 'hide'}
# cat("Working directory: ", getwd()) # turn on to test the location
report_render_start_time <- Sys.time()
# set options shared by all chunks
opts_chunk$set(
  results      = 'show',
  message      = FALSE,
  warning      = FALSE,
  comment      = NA,
  tidy         = FALSE,
  # dpi        = 400, # dots per inch,
  # out.width  = "650px", # pixels, this affects only the markdown, not the underlying png file.  The height will be scaled appropriately.
  fig.width    = 6, # inches
  fig.height   = 4, # inches
  fig.path     = 'figure-png-iso/' # where figures are stored
)
echo_chunks    <- FALSE #Toggle for debugging.
message_chunks <- FALSE #Toggle for debugging.
options(width=100) # number of characters to display in the output (dflt = 80)
ggplot2::theme_set(ggplot2::theme_bw()) # common theme for all graphs
read_chunk("./analysis/survey-overview/survey-overview-hatsko.R") #This allows knitr to call chunks tagged in the underlying *.R file.
Sys.setlocale("LC_CTYPE", "ukr")
```

# Environment

> Reviews the components of the working environment of the report. Non-technical readers are welcomed to skip. Come back if you need to understand the origins of custom functions, scripts, or data objects.

<details>

<summary>Packages used </summary>

Packages used in current report

```{r load-packages, message=message_chunks, echo=T, results="hide"}
```

</details>

<details>

<summary>External scripts </summary>

Collection of custom functions used in current repository (`sda-information-requests`)

```{r load-sources, message=message_chunks, echo=T, results="hide"}
```

</details>

<details>

<summary>Global values </summary>

Values used throughout the report.

```{r declare-globals, message=message_chunks, echo=T, results="hide"}
```

</details>

<details>

<summary>Functions </summary>

Custom functions defined for use in this report.

```{r declare-functions, message=message_chunks, echo=T, results="hide"}
```

</details>

# Data

## Input

```{r load-data, results='show', message=FALSE, cache = T, echo=F, eval=T}
```

<details>

<summary>click to glimpse </summary>

```{r inspect-data, results='show', message=message_chunks,cache=F, class.source = "fold-show"}
```

</details>

Next, we define useful sets of variable names to be used throughout the report

<details>

<summary>click to see the groups </summary>

```{r variable-groups, results='show', message=message_chunks,cache=F, class.source = "fold-show"}
```

</details>

<details>

<summary>meta data </summary>

```{r meta-data-1,  class.source = "fold-show"}
```

</details>

## Transformations

For the state `ds0`, we augment the focal table of the report with additional columns and transform existing variable to better fit visualization/modeling needs

```{r tweak-data-0, results='show', message=message_chunks,cache=F, class.source = "fold-hide"}
```

To make our analysis more nimble we create four alternative versions of `ds1` with Invasion Preparedness questions

<details>

<summary>show transformations </summary>

```{r tweak-data-1-prep,  class.source = "fold-show"}
```

```{r tweak-data-1-info,  class.source = "fold-show"}
```


</details>

<details>

<summary>examine the versions </summary>

```{r inspect-data-1,  class.source = "fold-show"}
```

</details>

# Variable List

The following variables are present in the processed data table of survey responses:

```{r results='show', message=message_chunks,cache=F, class.source = "fold-hide"}
ds0 %>% explore::describe_all() %>%neat_DT()
```

# 0. Introduction

<mark>0.1</mark> What is the goal of this report?

> This report overviews the responses to the survey conducted by KSE Institute in Ukraine during 2022


# 1. General Information

```{r results="show", class.source = "fold-hide"}
meta_survey %>% filter(group=="preamble") %>% pull(label) %>% cat()
```

<mark>1.1</mark> How many hromadas contributed responses to so far?

> As of `r Sys.Date() %>% as.character()`, `r ds0 %>% summarize(response_count = n_distinct(hromada_code)) %>% pull(response_count) %>% scales::comma()` hromadas contributed valid response to the survey

<mark>1.2</mark> What regions are represented in this sample? 

```{r representation-region, class.source="fold-hide"}

ds_survey %>% 
  group_by(region_en) %>% 
  summarize(
    hromada_count = n_distinct(hromada_code)
    ,.groups = "drop"
  ) %>%
  mutate(hromada_survey_prop = hromada_count / sum(hromada_count)
         ,hromada_survey_pct = scales::percent(hromada_survey_prop, accuracy = .1)) %>% 
  right_join(
    ds_general %>% 
      group_by(region_en) %>% 
      summarize(hromada_count_total = n())
  ) %>% 
  filter(!is.na(region_en)) %>%
  mutate(
    hromada_count = replace_na(hromada_count, 0)
    ,hromada_total_prop = hromada_count_total / sum(hromada_count_total)
    ,hromada_total_pct = scales::percent(hromada_total_prop, accuracy = .1)
  ) %>%
  arrange(region_en, desc(hromada_survey_prop)) %>% 
  select(-c(hromada_survey_prop, hromada_total_prop)) %>%
  relocate(hromada_count_total, .after = hromada_count) %>%
  ungroup() %>%
  # neat_DT()
  gt::gt() %>%
  gt::cols_label(region_en = 'Region',
                 hromada_count_total = 'Total number \nof ATCs',
                 hromada_count = 'ATCs in the survey',
                 hromada_total_pct = 'Proportion of Region \nin the General Population',
                 hromada_survey_pct = 'Proportion of Region \nin the Survey'
  )

```


<mark>1.3</mark> What oblasts are represented in this sample? 

```{r representation-oblast, class.source="fold-hide"}

ds_survey %>% 
  group_by(region_en, oblast_name_en) %>% 
  summarize(
    hromada_count = n_distinct(hromada_code)
    ,.groups = "drop"
  ) %>%
  mutate(hromada_survey_prop = hromada_count / sum(hromada_count)
         ,hromada_survey_pct = scales::percent(hromada_survey_prop, accuracy = .1)) %>% 
  right_join(
    ds_general %>% 
      group_by(region_en, oblast_name_en) %>% 
      summarize(hromada_count_total = n())
  ) %>% 
  filter(!is.na(region_en)) %>%
  mutate(
    hromada_count = replace_na(hromada_count, 0)
    ,hromada_total_prop = hromada_count_total / sum(hromada_count_total)
    ,hromada_total_pct = scales::percent(hromada_total_prop, accuracy = .1)
  ) %>%
  arrange(region_en, desc(hromada_survey_prop)) %>% 
  select(-c(hromada_survey_prop, hromada_total_prop)) %>%
  relocate(hromada_count_total, .after = hromada_count) %>%
  ungroup() %>%
  # neat_DT()
  gt::gt() %>%
  gt::cols_label(region_en = 'Region',
                 oblast_name_en = 'Oblast',
                 hromada_count_total = 'Total number \nof ATCs',
                 hromada_count = 'ATCs in the survey',
                 hromada_total_pct = 'Proportion of Oblast \nin the General Population',
                 hromada_survey_pct = 'Proportion of Oblast \nin the Survey'
  )

```


<mark>1.4</mark> What type of hromadas are represented in the sample? 

```{r representation-type, class.source="fold-hide"}

ds_survey %>% 
  group_by(type) %>% 
  summarize(
    hromada_count = n_distinct(hromada_code)
    ,.groups = "drop"
  ) %>%
  mutate(hromada_survey_prop = hromada_count / sum(hromada_count)
         ,hromada_survey_pct = scales::percent(hromada_survey_prop, accuracy = .1)) %>% 
  right_join(
    ds_general %>% 
      group_by(type) %>% 
      summarize(hromada_count_total = n())
  ) %>% 
  mutate(
    hromada_count = replace_na(hromada_count, 0)
    ,hromada_total_prop = hromada_count_total / sum(hromada_count_total)
    ,hromada_total_pct = scales::percent(hromada_total_prop, accuracy = .1)
    ,type = case_when(type == 'міська' ~ "urban",
                      type == 'селищна' ~ "urban village",
                      type == 'сільська' ~ "village"
                      )
  ) %>%
  arrange(desc(hromada_survey_prop)) %>% 
  select(-c(hromada_survey_prop, hromada_total_prop)) %>%
  relocate(hromada_count_total, .after = hromada_count) %>%
  ungroup() %>%
  # neat_DT()
  gt::gt() %>%
  gt::cols_label(type = 'Type of Hromada',
                 hromada_count_total = 'Total number \nof ATCs',
                 hromada_count = 'ATCs in the survey',
                 hromada_total_pct = 'Proportion of Hromada Type \nin the General Population',
                 hromada_survey_pct = 'Proportion of Hromada Type \nin the Survey'
  )

```


mark>1.4</mark> What hromadas experienced military occupation or  military actions? 
```{r fig.height=4, fig.width=8, class.source="fold-hide"}
(ds0 %>% make_bi_freq_graph("military_action"))+
  labs(
    title = "How many respondent hromadas have experienced military action at the time of the interview?"
    ,subtitle = "Data were collected during October-November of 2022"
    ,y = NULL
  )

(ds0 %>% make_bi_freq_graph("occupation"))+
  labs(
    title = "How many respondent hromadas have experienced occupation at the time of the interview?"
    ,subtitle = "Data were collected during October-November of 2022"
    ,y=NULL
  )
ds0 %>% make_bi_freq_graph("military_action","occupation")
ds0 %>% make_bi_freq_graph("occupation","military_action")

```


<mark>1.5</mark> How many partherships with other hromadas in Ukraine hromadas have?

```{r partnerships-count, class.source="hide", cache=T}

ds_partners <- ds0 %>% 
  mutate(partners_text = as.numeric(partners_text)) %>% 
  summarise(median = median(partners_text, na.rm =  T),
            mean = mean(partners_text, na.rm =  T),
            max = max(partners_text, na.rm =  T)) 
```

> Median number of partnerships that hromada has is `r ds_partners$median`, mean - `r round(ds_partners$mean, 2)`. 
Maximum number of partnerships that hromada has in our survey is `r ds_partners$max`.

```{r partnerships-hist, fig.height=7, fig.width=8, class.source="fold-hide"}
ds0 %>% 
  mutate(partners_text = as.numeric(partners_text)) %>% 
  select(hromada_full_name, partners_text) %>%
  mutate(partners_group = cut(partners_text, 
                              breaks = c(0, 1, 2, 3, 4, 20), 
                              labels = c('None', '1', '2', '3', 'More than 3'),
                              right = F)) %>%
  na.omit() %>%
  ggplot(aes(x=partners_group, group = 1)) +
  geom_bar(aes(y = ..prop..), stat = 'count') +
  geom_text(aes(label = scales::percent(..prop..), y = ..prop..), stat = 'count', vjust = -.4) +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(
    title = "How many partnerships hromadas have?"
    ,y = NULL, x = NULL
  )

```

> These are hromadas that have the most partnerships:

```{r partnerships-top, class.source="fold-hide"}
ds0 %>% 
  mutate(partners_text = as.numeric(partners_text)) %>%
  select(hromada_full_name, partners_text) %>%
  slice_max(partners_text, n = 5) %>%
  rename('Hromada Name' = "hromada_full_name"
         , "Number of hromada's partnerships in Ukraine" = "partners_text") %>%
  neat()

```

<mark>1.6</mark> How many hromadas-friends abroad hromadas have?

```{r friends-hist, fig.height=7, fig.width=8, class.source="fold-hide"}
ds0 %>% 
  mutate(friends_text = as.numeric(friends_text)) %>% 
  select(hromada_full_name, friends_text) %>%
  mutate(friends_group = cut(friends_text,
                              breaks = c(0, 1, 2, 3, 4, 5, 20), 
                              labels = c('None', '1', '2', '3', '4', 'More than 4'),
                              right = F)) %>%
  na.omit() %>%
  ggplot(aes(x=friends_group, group = 1)) +
  geom_bar(aes(y = ..prop..), stat = 'count') +
  geom_text(aes(label = scales::percent(..prop..), y = ..prop..), stat = 'count', vjust = -.4) +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(
    title = "How many hromadas-friends abroad hromadas have?"
    ,y = NULL, x = NULL
  )

```

> These are hromadas that have the most friends abroad:

```{r friends-top, class.source="fold-hide"}
ds0 %>% 
  mutate(friends_text = as.numeric(friends_text)) %>%
  select(hromada_full_name, friends_text) %>%
  slice_max(friends_text, n = 10) %>%
  rename('Hromada Name' = "hromada_full_name"
         , "Number of hromada's friends abroad" = "friends_text") %>%
  neat()

```

# 2. Preparation



```{r preparation-summary-1, fig.height=5, fig.width=12,class.source="fold-hide", cache=T}


d1 <- 
  ds1_prep_ordinal_factors %>% 
  pivot_longer(cols = preparation, names_to = "item_name") %>% 
  group_by(item_name,value) %>% 
  summarize(
    count = n_distinct(hromada_code)
    ,.groups = "drop"
  ) %>% 
  group_by(item_name) %>% 
  mutate(
    prop = count/sum(count, rm.na = T)
    ,pct = scales::percent(prop, accuracy = 1)
  ) %>% 
  ungroup()

d2 <- 
  ds1_prep_binary_factors %>% 
  pivot_longer(cols = preparation, names_to = "item_name") %>% 
  group_by(item_name,value) %>% 
  summarize(
    count = n_distinct(hromada_code)
    ,.groups = "drop"
  ) %>% 
  group_by(item_name) %>% 
  mutate(
    prop = count/sum(count, rm.na = T)
    ,pct = scales::percent(prop, accuracy = 1)
  ) %>% 
  ungroup()

d12 <- 
  bind_rows(
    d1
    ,d2 %>% filter(value == "Yes")
  ) %>% 
  left_join(
    d_meta_prep
  ) %>% 
  arrange(item_name, value) 

d_in <- 
  d12 %>% 
    mutate(
    display_name = label_en
    ,display_name = factor(
      display_name
      ,levels =  d12 %>%
        left_join(d_meta_prep) %>%
        filter(value == "Yes") %>%
        # filter(value == "Before Feb 24") %>%
        arrange(prop) %>%
        # arrange(desc(item_number)) %>%
        pull(label_en)
    ) # display_name
    ,value = fct_relevel(
      value
      , "As of Oct", "As of Feb","Yes", "No", "Not Applicable",
    ) %>% fct_rev()
  ) 

g <- 
  d_in %>% 
  { 
  ggplot(
    data = (.) %>% filter(value !="Yes") %>% mutate(value=factor(value))
    ,aes(x=prop, y = display_name, fill=value)
  )+
  geom_col(position = position_stack()
           , alpha = .7
           ,data =
  )+
  geom_text(aes(label = str_remove(pct,"\\%"))
            ,hjust = 1
            , size = 4
            ,color="white"
            ,position = position_stack()
            ,data = . %>% filter(value !="Yes")
            )+
  geom_text(aes(label = str_remove(pct,"\\%"))
            ,hjust = -.5
            ,vjust = .5
            , size = 2
            ,color="black"
            ,position = position_stack()
            ,data = (.) %>% filter(value=="Yes") %>% mutate(value=NA)

            )+
  scale_x_continuous(
    breaks = seq(.1,1,.1)
    ,labels = scales::percent_format()
    ,expand = expansion(add=c(-.000,-.0))
  )+
  scale_fill_viridis_d(
    begin = .8, end = .0, direction = -1
    , option = "plasma", guide= guide_legend(reverse=T)
  )+
  labs(
    title = "Have your hromada made the following preparations?"
    ,x = "Percent of respondents", y = NULL, fill = NULL
    ,caption = "Cummulative percent shown in black"
  )+
  theme(
    # panel.grid = element_blank()
    panel.grid.major.y  = element_blank()
    ,panel.border = element_blank()
    ,panel.grid.major.x = element_line(color = "black")
  )
  }

g
# g %>% quick_save("2-preparation-summary-yes",w=12,h=5)
```

<mark>2.1</mark> What questions were asked about preparations hromadas made? 

```{r class.source = "fold-hide"}
ds0 %>% 
  select(preparation) %>% 
  explore::describe_all() %>% 
  left_join(
    meta_survey %>% filter(group=="preparation") %>% select(name,label_en,label)
    ,by=c("variable"="name")) %>% 
  relocate(c("label_en","label"),.after = "variable") %>% 
  select(1:3) %>%
  neat()
```

## Item-total correlations 


We can conceptualize hromadas' the preparation for invasion as two quantities:  
- `prep_score_feb` - the number of security measures implemented as of February 2022   
- `prep_score_oct` - the number of security measures implemented as of October 2022

```{r}
ds1_prep %>% select(1:4) # + individual preparation items
```
We  also compute `prep_score_combo`, which is a sum of `prep_score_feb` and `prep_score_oct`, the quantity equivalent to weighting the implementation of security measures  prior to Feb 24, 2022 **twice as important**.

These three scores are distributed as follows:  
```{r info-score-distribution, fig.height=6, fig.width=5,class.source="fold-hide", cache=F}
g <-  
  ds1_prep %>%
  select(starts_with("prep_score")) %>% 
  pivot_longer(cols = everything(),names_to = "measure",values_to="value") %>% 
  mutate( 
    measure = factor(measure,
                        levels = c("prep_score_feb","prep_score_oct","prep_score_combo")
                        ,labels = c("..as of February","..as of October", "Combined = Feb + Oct")
                        )
  ) %>% 
  ggplot(aes(x=value))+
  geom_histogram(binwidth = 1, alpha = .4)+
  scale_x_continuous(breaks = seq(0,30,5),minor_breaks = NULL)+
  facet_wrap("measure",ncol =1)+
  labs(
    title = "How many security measures have your hromada implemented..."
    # ,subtitle = "Combined score = February + October"
  )
g
# g %>%  quick_save("score-distribution",w=3.5, h=6)
```

```{r fig.height=7, fig.width=8,class.source="fold-hide", cache=T}
ds1_prep %>% select(starts_with("prep_score")) %>% GGally::ggpairs()
# Note that correlation coefficient is Pearson
```

The item-total correlations indicates that all three preparedness scores are adequate unidimensional measures.

```{r prep-item-total, fig.height=4, fig.width=8,class.source="fold-hide", cache=T}

# Step 1 - create data sets with re-coded item responses
# As of February 2022, how many of these security steps have been implemented?
d_feb <- 
  ds_survey %>% 
  mutate(
    across(
      .cols = preparation
      ,.fns = ~case_when(
        .  == 0 ~ 0 #"No"
        ,. == 1 ~ 0 #"After Feb 24"
        ,. == 2 ~ 1 #"Before Feb 24"
      )
    )
  ) %>% 
  select(hromada_code, preparation)


# As of October 20200, how many of these security steps have been implemented?
d_oct <- 
  ds_survey %>% 
  mutate(
    across(
      .cols = preparation
      ,.fns = ~case_when(
        .  == 0 ~ 0 #"No"
        ,. == 1 ~ 1 #"After Feb 24"
        ,. == 2 ~ 1 #"Before Feb 24"
      )
    )
  ) %>% 
  select(hromada_code, preparation)

# What is the combined score of preparedness if we give 2 points for having
# a security measure implemented as of February, and 1 point - as of October?
d_combo <- 
  ds_survey %>% 
  select(hromada_code, preparation)



# convert to matrices
m_feb <- 
  ds1_prep %>% select(hromada_code, starts_with("prep_score_")) %>% 
  left_join(d_feb) %>% # raw scores have been converted to binary for as of Feb
  select(-hromada_code) %>% 
  make_corr_matrix(na_action = "remove", method="spearman")

m_oct <- 
  ds1_prep %>% select(hromada_code, starts_with("prep_score_")) %>% 
  left_join(d_oct) %>% # raw scores have been converted to binary for as of Oct
  select(-hromada_code) %>% 
  make_corr_matrix(na_action = "remove", method="spearman")

m_combo <- 
  ds1_prep %>% select(hromada_code, starts_with("prep_score_")) %>% 
  left_join(d_combo) %>% 
  select(-hromada_code) %>% 
  make_corr_matrix(na_action = "remove", method="spearman")


d_item_total <- 
  list(
    "Combination" = m_combo[,"prep_score_combo"]
    ,"February"  = m_feb[,"prep_score_feb"]
    ,"October"  = m_oct[,"prep_score_oct"]
  ) %>% 
  as_tibble() %>% 
  mutate(item_name = rownames(m_combo)) %>% 
  filter(item_name != c("prep_score_combo","prep_score_feb","prep_score_oct")) %>% 
  mutate(item_name = factor(item_name)) %>% 
  relocate(item_name) %>% 
  pivot_longer(
    cols = 2:4
    ,names_to = "scenario"
    ,values_to = "correlation"
  ) %>% 
  mutate(
    discrimination = case_when(
      correlation <= 0  ~ "problematic"
      ,correlation > 0 & correlation < .2 ~ "poor"
      ,correlation >=.2 & correlation < .4 ~ "good"
      ,correlation >=.4  ~ "very good"
    ) %>% factor(levels = c("problematic","poor","good","very good"))
    ,scenario = scenario %>% factor(
      labels=c("February","October","Combination"))
    ,item_name = factor(item_name,levels = preparation) %>% fct_rev()
  )

discrimination_levels <- c(
  "problematic" = "#d01c8b"
  ,"poor"        = "#f1b6da"
  ,"good"        = "#b8e186"
  ,"very good"   = "#4dac26"
)

g_item_total <-
  d_item_total %>% 
  ggplot(aes(x = item_name, y = correlation, color = discrimination, group = scenario))+
  geom_line(aes(group = "scenario"))+
  geom_point()+
  geom_text(aes(label=correlation %>% scales::number(accuracy = .01) %>% RemoveLeadingZero()),hjust=-.3
            ,size = 3)+
  geom_hline(aes( yintercept = 0))+ 
  facet_wrap("scenario",nrow=1)+
  scale_y_continuous(limits = c(-.3,.7), expand = expansion(add = c(0,.2)))+
  scale_color_manual(
    values = discrimination_levels
    , limits = names(discrimination_levels)
  )+
  coord_flip() +
  labs(
    title = "Item-total corellations under three scoring scenarios"
    ,y = "Item-total Correlation (Spearman)"
    ,x = NULL
    ,color = "Discrimination"
  )

g_item_total
g_item_total %>% quick_save("item-total",w=8,h=4)
```

While all three metrics should be considered during modeling, the next section demonstrates why and how the interpreations of these scores will differ

## Prep score change
 
Let's us visualize individual scores of invasion preparedness
```{r prep-change-segment-1, eval=T,fig.width=5.5, fig.height=8,class.source="fold-hide"}
d <- 
  ds1_prep %>% 
  select(hromada_code, starts_with("prep_score_")) %>% 
arrange(prep_score_oct, prep_score_feb) 

make_plot_prep_change_bw <- function(
    d
    ,order_by #= c("prep_score_feb","prep_score_oct")
    ,color_by #= "row_number_ntile"
    ,ntile_count = 10
){
  # browser()
  
  level_order <- d %>% arrange(!!!rlang::syms(order_by)) %>% pull(hromada_code)
  caption_text = paste0("Order by: ", paste0(order_by,collapse = " + "), " | Color by: ", color_by)
  g <- 
    d %>%
    arrange(!!!rlang::syms(order_by)) %>% 
    mutate(
      hromada_code = hromada_code %>% factor(levels = level_order)
      ,prep_score_combo_ntile = ntile(prep_score_combo,ntile_count)        %>% factor()
      ,prep_score_feb_ntile   = ntile(prep_score_feb,ntile_count) %>% factor()
      ,prep_score_oct_ntile   = ntile(prep_score_oct,ntile_count)  %>% factor()
      ,row_number_ntile       = ntile(row_number(),ntile_count)      %>% factor()
    ) %>% 
    # graphing begins
    ggplot(aes(y=hromada_code, color = !!rlang::sym(color_by) ))+
    geom_segment(
      aes(
        y     = hromada_code
        ,yend = hromada_code
        ,x    = prep_score_feb
        ,xend = prep_score_oct
      )
      ,linewidth = 2 ,alpha = 1
    )+
    geom_segment(
      aes(
        y     = hromada_code
        ,yend = hromada_code
        ,x    = 0
        ,xend = prep_score_feb
      )
      ,linewidth = 2 ,alpha = .1
      , color = "black"
    )+
    scale_color_brewer(type="div", palette = "Spectral")+
    scale_x_continuous(
      breaks = seq(0,15,5),minor_breaks = seq(0,15,1)
      # ,limits = c(-10,25)
      )+
    labs(
      title = paste0("The number of security measures implemented by hromadas (N= ",
                     d %>% summarize(n=n_distinct(hromada_code)) %>% pull(n)
                     ,")")
      ,subtitle = caption_text
      ,x = "Each segment starts at February and ends at October preparedness score"
      # ,caption = caption_text
      ,y = NULL
      ,color = "Percentile\nGroup\n"
    )+
    theme(
      axis.text.y = element_blank()
      ,panel.grid.major.y = element_blank()
      ,panel.border = element_blank()
    )+
    guides(color = guide_legend(override.aes = list(linewidth=7), reverse=TRUE))
  return(g)
}
# Ordering by the total score (before + after OR sum(0|1|2)) 
g <- d %>% make_plot_prep_change_bw(order_by = "prep_score_combo",color_by = "prep_score_combo_ntile") # 
g + labs(color = "Percentile\nGroup\n(Combo)")
# g %>% quick_save("prep-change-segment-bw",w=5.5,h=9)
```

However,this scoring method may not work for operationalizing preparedness as of October

```{r prep-change-segment-2, eval=T,fig.width=5.5, fig.height=8,class.source="fold-hide"}
g <- d %>% make_plot_prep_change_bw(order_by = c("prep_score_oct","prep_score_feb"), color_by = "prep_score_combo_ntile")
g + labs(color = "Percentile\nGroup\n(Combo)")
```

or as of February

```{r prep-change-segment-3, eval=T,fig.width=5.5, fig.height=8,class.source="fold-hide"}
g <- d %>% make_plot_prep_change_bw(order_by = c("prep_score_feb","prep_score_oct"), color_by = "prep_score_combo_ntile")
g + labs(color = "Percentile\nGroup\n(Combo)")
```


 
<mark>**Conclusion**</mark> 

> Both `prep_score_feb` and `prep_score_oct` are meaningful, adequate unidimensional measures with a straightforward interpretation: *Number of security measures implemented as of a given date*. 

> The measure `prep_score_combo` is also an adequate unidimensional measure, but it does not have a clear interpretation of its value.

 
 
```{r prep-vs-scatter, eval=F, echo=F}
# Continuous - good for spreading out
comparison_vars_continuous <- c(
   "income_own_per_capita"           
  ,"income_total_per_capita"         
  ,"income_tranfert_per_capita"      
  ,"idp_registration_share"
  ,"idp_real_share"
  ,"idp_child_share"
  
  
  ,"square"
  ,"n_settlements"
  ,"travel_time"
  ,"urban_pct"
  ,"total_population_2022"
  ,"urban_population_2022"                              
  ,"sum_osbb_2020"                                      
  ,"turnout_2020"
  ,"age_head"
  ,"time_before_24th"
)
# Categorical - for color
comparison_vars_discreate <- c(
   "sex_head"
  ,"education_head"
  ,"type"
  ,"voluntary"
  ,"region_en"
)
comparison_vars <- c(
  comparison_vars_discreate
   ,comparison_vars_continuous
)

d <- 
  ds1_prep %>% 
  select(hromada_code, starts_with("prep_score")) %>% 
  left_join(ds0 %>% select(hromada_code,all_of(comparison_vars))) %>% glimpse() %>% 
  mutate(
    across(
      .cols = comparison_vars_discreate
      ,.fns = ~factor(.)
    )
  ) %>%
  pivot_longer(
    cols = comparison_vars_continuous
    ,names_to = "item_name"
    ,values_to = "item_value"
  ) %>% glimpse()

make_plot_prepvs <- function(
    d
    ,xvar    # "prep_score"
    ,yvar    # "item_value"
    ,fillvar # "region_en"
    )
{
  g <- 
  d %>% 
  ggplot(aes(
      x     = !!rlang::sym(xvar)
      ,y    = !!rlang::sym(yvar)
      ,fill = !!rlang::sym(fillvar)
      ))+
  ggplot2::scale_fill_viridis_d(
    begin = 0, end = .8, direction = -1
    ,option = "plasma",guide= guide_legend(reverse=T)
  )+
  facet_wrap(facets = "item_name", scales = "free_y")+
  geom_point(shape=21,color = "black", size =3, alpha = .5, position=position_jitter(seed=42))+
    labs(
      title = paste0("Relationship between Invasion Preparedness Score (horizontal) and other attributes of hromadas")
    )
}  
# To see how it works
d %>% 
  make_plot_prepvs(
    xvar     = "prep_score"
    ,yvar    = "item_value"
    ,fillvar = "region_en"
  )  

# To execution multiple scenarios
for(i in comparison_vars_discreate){
  
  for(ii in c("prep_score","prep_score_before","prep_score_after")){
    g <- 
      d %>% 
      make_plot_prepvs(
        xvar     = ii
        ,yvar    = "item_value"
        ,fillvar = i
      )  %>% 
      file_name <- paste0(ii,"-",i)
    g %>% quick_save(paste0("/1/",file_name),w=12,h=8)
    }
}

```


```{r prep-change-segment-color, eval=F, echo=F}
# Continuous - good for spreading out
comparison_vars_continuous <- c(
   "income_own_per_capita"           
  ,"income_total_per_capita"         
  ,"income_tranfert_per_capita"      
  ,"idp_registration_share"
  ,"idp_real_share"
  ,"idp_child_share"
  
  
  ,"square"
  ,"n_settlements"
  ,"travel_time"
  ,"urban_pct"
  ,"total_population_2022"
  ,"urban_population_2022"                              
  ,"sum_osbb_2020"                                      
  ,"turnout_2020"
  ,"age_head"
  ,"time_before_24th"
)
# Categorical - for color
comparison_vars_discreate <- c(
   "sex_head"
  ,"education_head"
  ,"type"
  ,"voluntary"
  ,"region_en"
)
comparison_vars <- c(
  comparison_vars_discreate
   ,comparison_vars_continuous
)

d <- 
  ds1_prep %>% 
  select(hromada_code, starts_with("prep_score")) %>% 
  left_join(ds0 %>% select(hromada_code,all_of(comparison_vars))) 

d %>% glimpse()

make_plot_prep_change <- function(
  d
  ,ordervar = "prep_score"
  ,colorvar = "region_en"
){
# browser()
g <- 
  d %>% 
  mutate(
    hromada_code = hromada_code %>% factor() %>% fct_reorder(!!rlang::sym(ordervar))
  ) %>% 
  # sample_n(10) %>% 
  # slice(1:10) %>% 
  ggplot(aes(y=hromada_code, color = !!rlang::sym(colorvar)))+
  geom_segment(
    aes(
      y     = hromada_code
      ,yend = hromada_code
      ,x    = prep_score_before
      ,xend = prep_score_after
      # ,x    = 0                                   # to see only after 
      # ,xend = prep_score_after-prep_score_before  # to see only after
    )
    ,linewidth = 2 ,alpha = .6
  )+
  labs(
    title = paste0("The number of preparedness items secured by hromadas (N= ",
                   d %>% summarize(n=n_distinct(hromada_code)) %>% pull(n)
                   ,") before and after full scale invasion")
    ,subtitle = "Scale guide: (Before) = prior to Feb 24, (After) = at time of interview, Oct-Nov 2022, (Total) = Before + After"
    ,x = "Each segment starts at (Before) score and ends at (After)"
  )+
  # scale_color_viridis_d(
  #   begin = .8, end = .0, direction = -1
  #   , option = "plasma", guide= guide_legend(reverse=T)
  # )+
  scale_color_viridis_c(
    # begin = .8, end = .0, direction = -1
    # , option = "plasma", guide= guide_legend(reverse=T)
  )+
  # scale_color_brewer(type="qual", palette = "Dark2")+
  theme(
    axis.text.y = element_blank()
  )
return(g)
}
(
  d %>% 
  make_plot_prep_change(
    ordervar = "prep_score"
    ,colorvar = "income_own_per_capita"
  )
) %>% 
  quick_save("prep-change-segment-color",w=6,h=9)

```

# 3. Information


```{r results="show", class.source="fold-hide"}
meta_survey %>% filter(group=="information_hat") %>% pull(label) %>% cat()
```

```{r information-summary-1, fig.height=3, fig.width=12,class.source="fold-hide"}

d1 <- 
  ds1_info %>% 
  pivot_longer(
    cols = item_information
    ,names_to = "item_name"
    ,values_to = "item_response"
  ) %>% 
  group_by(item_name,item_response) %>% 
  summarize(
    count = n_distinct(hromada_code)
    ,.groups = "drop"
  ) %>% 
  group_by(item_name) %>% 
  mutate(
    prop = count/sum(count, rm.na = T)
    ,pct = scales::percent(prop, accuracy = 1)
  ) %>% 
  ungroup()

d2 <- 
  ds1_info %>% 
   pivot_longer(
    cols = item_information
    ,names_to = "item_name"
    ,values_to = "item_response"
  ) %>% 
  mutate(
    item_response = case_when(
      item_response != "No" ~ "Yes"
    )
  ) %>%
  group_by(item_name,item_response) %>% 
  summarize(
    count = n_distinct(hromada_code)
    ,.groups = "drop"
  ) %>% 
  group_by(item_name) %>% 
  mutate(
    prop = count/sum(count, rm.na = T)
    ,pct = scales::percent(prop, accuracy = 1)
  ) %>% 
  ungroup()

d12 <- 
  bind_rows(
    d1
    ,d2 %>% filter(item_response == "Yes")
  ) %>% 
  left_join(
    d_meta_info
  ) %>% 
  arrange(item_name, item_response) 

d_in <- 
  d12 %>% 
    mutate(
    display_name = label_en
    ,display_name = factor(
      display_name
      ,levels =  d12 %>%
        left_join(d_meta_info) %>%
        filter(item_response == "Yes") %>%
        # filter(value == "Before Feb 24") %>%
        arrange(prop) %>%
        # arrange(desc(item_number)) %>%
        pull(label_en)
    ) # display_name
    ,item_response = fct_relevel(
      item_response
      , "Before Feb 24", "After Feb 24","Yes", "No", "Not Applicable",
    ) %>% fct_rev()
  ) 

g <- 
  d_in %>% 
  { 
  ggplot(
    data = (.) %>% filter(item_response !="Yes") %>% mutate(item_response=factor(item_response))
    ,aes(x=prop, y = display_name, fill=item_response)
  )+
  geom_col(position = position_stack()
           , alpha = .7
           ,data =
  )+
  geom_text(aes(label = str_remove(pct,"\\%"))
            ,hjust = 1
            , size = 4
            ,color="white"
            ,position = position_stack()
            ,data = . %>% filter(item_response !="Yes")
            )+
  geom_text(aes(label = str_remove(pct,"\\%"))
            ,hjust = -.5
            ,vjust = .5
            , size = 2
            ,color="black"
            ,position = position_stack()
            ,data = (.) %>% filter(item_response=="Yes") %>% mutate(item_response=NA)

            )+
  scale_x_continuous(
    breaks = seq(.1,1,.1)
    ,labels = scales::percent_format()
    ,expand = expansion(add=c(-.000,-.0))
  )+
  scale_fill_viridis_d(
    begin = .8, end = .0, direction = -1
    , option = "plasma", guide= guide_legend(reverse=T)
  )+
  labs(
    title = "What channels of communication are used to dissiminate information?"
    ,x = "Percent of respondents", y = NULL, fill = NULL
    ,caption = "Cummulative percent shown in black"
  )+
  theme(
    # panel.grid = element_blank()
    panel.grid.major.y  = element_blank()
    ,panel.border = element_blank()
    ,panel.grid.major.x = element_line(color = "black")
  )
  }

g
```

```{r info-2, fig.height=3, fig.width=9,class.source="fold-hide"}

d <- 
  ds0 %>%  
  select(hromada_code,head_hromada_communication, facebook,viber,telegram ) %>% 
  pivot_longer(cols = c("facebook","viber","telegram")) %>% 
  mutate(
    had_sn_before = case_when(
      value %in% c(0,1) ~ "No cccount before Feb24"
      ,value %in% c(2)  ~ "Had cccount before Feb24"
    )
  ) %>% 
  arrange(hromada_code, head_hromada_communication) %>% 
  group_by(hromada_code,head_hromada_communication) %>% 
  mutate(
    had_any_sn_before_feb24 = sum(value==2,na.rm = T)>0
  ) %>% 
  ungroup() %>% 
  distinct(hromada_code, head_hromada_communication,had_any_sn_before_feb24) %>% 
  mutate(
    time_per_week = fct_recode(head_hromada_communication,
        "1"  = "once_a_week"    
      , "7"  = "once_a_day"   
      , "0"  = "none"   
      , "3"  = "few_times_a_week"  
      , "15" = "2_3_times"   
    ) %>% as.character() %>% as.integer()
    , head_hromada_communication = fct_recode(
      head_hromada_communication,
       "Once a week"      = "once_a_week"
      ,"Once a day"       = "once_a_day"
      ,"Never"            = "none"
      ,"Few times a week" = "few_times_a_week"
      ,"2-3 times a day"  = "2_3_times"
    ) %>% factor( levels = c(
       "Never"           
       ,"Once a week"     
       ,"Few times a week"
       ,"Once a day"      
       ,"2-3 times a day"
    )
    )
  ) 
(d %>% make_bi_freq_graph("had_any_sn_before_feb24")) +
  labs(
    title = "Did hromadas have account on any social network before the invasion?"
    ,subtitle = "Social networks considered: Facebook, Viber, Telegram"
    ,y = NULL, x = NULL, fill = "Had account"
  ) +
  scale_x_discrete(labels=c('TRUE' = 'Had account', 'FALSE' = 'No account')) +
  scale_fill_discrete(labels=c('TRUE' = 'Had account', 'FALSE' = 'No account'))
```


```{r results="show", class.source="fold-hide"}
meta_survey %>% filter(group=="information_freq") %>% pull(label) %>% cat()
```


```{r info-1 , fig.height=3, fig.width=9,class.source="fold-hide"}
(ds0 %>% 
  mutate(
    
    head_hromada_communication = fct_recode(
      head_hromada_communication,
       "Once a week"      = "once_a_week"
      ,"Once a day"       = "once_a_day"
      ,"Never"            = "none"
      ,"Few times a week" = "few_times_a_week"
      ,"2-3 times a day"  = "2_3_times"
    ) %>% factor( levels = c(
       "Never"           
       ,"Once a week"     
       ,"Few times a week"
       ,"Once a day"      
       ,"2-3 times a day"
    )
    )
  ) %>% 
  make_bi_freq_graph("head_hromada_communication") )+
  labs(
    title = "How frequently did hromada head communicated in the first month of invasion?"
    ,x = NULL, fill = NULL
  )

```

```{r info-3 , fig.height=3, fig.width=9,class.source="fold-hide"}

d %>% 
  group_by(had_any_sn_before_feb24) %>% 
  summarize(mean_times_per_week = mean(time_per_week,na.rm =T)) %>% 
  ggplot(aes(x=mean_times_per_week, y= had_any_sn_before_feb24,
             fill = had_any_sn_before_feb24))+
  geom_col()+
  geom_text(aes(label=scales::comma(mean_times_per_week)))+
  labs(
    title = "How frequently did heads of hromadas communicate with the community during the first month of invation \ndepending on having any social account before 24th February?"
    ,subtitle = "Social networks considered: Facebook, Viber, Telegram"
    ,y = NULL, x = "Average times per week", fill = "Had account on\nany social network"
  ) +
  scale_y_discrete(labels=c('TRUE' = 'Had account', 'FALSE' = 'No account')) +
  scale_fill_discrete(labels=c('TRUE' = 'Had account', 'FALSE' = 'No account'))

```

```{r info-4 , fig.height=3, fig.width=9,class.source="fold-hide"}

d %>% 
  group_by(head_hromada_communication,had_any_sn_before_feb24) %>% 
  summarize(
    hromada_count = n_distinct(hromada_code)
    ,.groups = "drop"
  ) %>% 
  group_by(had_any_sn_before_feb24) %>% 
  mutate(
    prop = hromada_count/sum(hromada_count)
    ,pct = scales::percent(prop, accuracy = 1)
  ) %>% 
  ggplot(aes(x=prop, y = head_hromada_communication, fill = had_any_sn_before_feb24))+
  geom_col(position = position_dodge())+
  geom_text(aes(label = pct), hjust = -.5,position = position_dodge(width = .9))+
  scale_x_continuous(labels = scales::percent_format(),expand = expansion(add = c(0,.1)))+
  ggplot2::scale_fill_viridis_d(begin = 0, end = .8, direction = -1, option = "plasma",guide= guide_legend(reverse=T)
                                ,labels = c('TRUE' = 'Had account', 'FALSE' = 'No account')
    )+
  labs(
    title = "How frequently did heads of hromadas communicated during the first month of invasion?"
    ,fill = "Had accounts\non social networks\nbefore Feb 24"
    ,x = "Percent of respondents in each group"
    , y = NULL
  )
```


# 4. National Resistance

```{r results="show", class.source="fold-hide"}
meta_survey %>% filter(name=="dftg_creation") %>% pull(label) %>% cat()

```

```{r dftg-1, fig.height=3, fig.width=9,class.source="fold-hide"}

d <- ds0 %>% 
  select(hromada_code, dftg_creation, type) %>%
  mutate(dftg_creation = factor(dftg_creation, levels = c('not_able', 'still_not', 'yes')),
         type = factor(type, levels = c('сільська', "селищна", "міська")),
         dftg_creation = fct_recode(dftg_creation,
             'Yes' = 'yes'
            ,"Didn't due to quick occupation" = 'not_able'
            ,'Still not created' = 'still_not')
  )

(d %>% make_bi_freq_graph('dftg_creation')) +
  labs(
    title = "Did hromadas create a voluntary formation of a territorial community?"
    ,y = NULL, x = NULL, fill = NULL
  )
```

Many village communities didn't have a voluntary formation of a territorial community at the time of the survey

```{r dftg-2, fig.height=3, fig.width=9,class.source="fold-hide"}
d %>%
  group_by(type) %>%
  count(dftg_creation) %>%
  mutate(prop = n/sum(n)
         ,pct = scales::percent(prop, accuracy = 1)) %>% 
  ggplot(aes(x=prop, y = dftg_creation, fill = type))+
  geom_col(position = position_dodge())+
  geom_text(aes(label = pct), hjust = -.5,position = position_dodge(width = .9))+
  scale_x_continuous(labels = scales::percent_format(),expand = expansion(add = c(0,.1)))+
  ggplot2::scale_fill_viridis_d(begin = 0, end = .8, direction = -1, option = "plasma",guide= guide_legend(reverse=T)
  )+
  labs(
    title = "Did hromadas create a voluntary formation of a territorial community?"
    ,fill = "Hromada Type"
    ,x = "Percent of respondents in each group"
    , y = NULL
  )
```

```{r dftg-date, fig.height=5, fig.width=9,class.source="fold-hide"}
d <- ds0 %>% select(dftg_creation_date) %>% group_by(dftg_creation_date) %>% 
  summarise(n = n()) %>%
  filter(!is.na(dftg_creation_date) & dftg_creation_date > '2021-12-28') %>%
  mutate(cum = cumsum(n))

p <- d %>%
  ggplot(aes(x = dftg_creation_date, y = cum)) +
  geom_point() +
  geom_vline(aes(xintercept = as.POSIXct('2022-02-24')), 
             color = 'red', linetype = 'dashed') +
  geom_vline(aes(xintercept = as.POSIXct('2021-12-29')), 
             color = 'red', linetype = 'dashed') +
  geom_rect(aes(xmin = as.POSIXct('2022-02-24'), xmax = as.POSIXct('2022-03-24'), 
                ymin = -Inf, ymax = Inf),
            color = 'coral1', fill = 'coral1', alpha = 0.02) +
  theme_bw() +
  theme(axis.title.y = element_blank(),
        axis.title.x = element_blank()) +
  scale_x_datetime(limits = c(as.POSIXct('2021-12-01'), as.POSIXct('2022-10-15')), date_breaks = '1 month') +
  annotate(geom = 'label', x = as.POSIXct('2021-12-31'), y = 80, size = 3,
           label = 'December 29th: \nThe order of formation and \nactivity of the voluntary \nformations of ATC was defined') +
  annotate(geom = 'label', x = as.POSIXct('2022-02-28'), y = 70, size = 3,
           label = 'Full-scale \nrussian invasion') +
  annotate(geom = 'text', x = as.POSIXct('2022-03-26'), y = 90, hjust = 0, size = 3,
           label = '59 voluntary formations of ATC \nafter a first month', fontface = 'italic') +
  labs(title = 'Number of DFTG created by ATCs')
p

```

```{r dftg-date-1, fig.height=5, fig.width=9,class.source="fold-hide"}
d <- ds0 %>% select(dftg_creation_date, type) %>% group_by(dftg_creation_date, type) %>% 
  filter(!is.na(dftg_creation_date) & dftg_creation_date > '2021-12-28') %>%
  summarise(n = n()) %>%
  pivot_wider(values_from = n, names_from = type) %>%
  rename(c = 'міська', v = 'сільська', s = 'селищна') %>%
  ungroup() %>% 
  mutate(c = replace_na(c, 0),
         v = replace_na(v, 0),
         s = replace_na(s, 0),
         c_cum = cumsum(c),
         s_cum = cumsum(s),
         v_cum = cumsum(v)) %>% 
  select(-c(c,v,s)) %>%
  pivot_longer(-dftg_creation_date, values_to = 'n', names_to = 'type')

p <- d %>%
  ggplot(aes(x = dftg_creation_date, y = n, color = type)) +
  geom_point() +
  geom_vline(aes(xintercept = as.POSIXct('2022-02-24')), 
             color = 'red', linetype = 'dashed') +
  geom_vline(aes(xintercept = as.POSIXct('2021-12-29')), 
             color = 'red', linetype = 'dashed') +
  geom_rect(aes(xmin = as.POSIXct('2022-02-24'), xmax = as.POSIXct('2022-03-24'), 
                ymin = -Inf, ymax = Inf),
            color = 'coral1', fill = 'coral1', alpha = 0.007) +
  theme_bw() +
  theme(axis.title.y = element_blank(),
        axis.title.x = element_blank(),
        legend.position = 'top') +
  scale_x_datetime(limits = c(as.POSIXct('2021-12-01'), as.POSIXct('2022-10-15')), date_breaks = '1 month') +
  scale_y_continuous(limits = c(0,40)) +
  scale_color_discrete(labels = c('c_cum' = 'City', 's_cum' = 'Urban Village', 'v_cum' = 'Village')) +
  annotate(geom = 'label', x = as.POSIXct('2021-12-31'), y = 36, size = 3,
           label = 'December 29th: \nThe order of formation and \nactivity of the voluntary \nformations of ATC was defined') +
  annotate(geom = 'label', x = as.POSIXct('2022-02-28'), y = 37, size = 3,
           label = 'Full-scale \nrussian invasion') +
  annotate(geom = 'text', x = as.POSIXct('2022-03-26'), y = 37, hjust = 0, size = 3,
           label = '59 voluntary formations of ATC \nafter a first month', fontface = 'italic') +
  labs(title = 'Number of DFTG created by ATCs', color = NULL)
p

```

## 4.1 Transport Help

# 5. Administrative Adaptation
```{r admin-percent-working, fig.height=6, fig.width=4,class.source="fold-hide", cache=T}

g <-  ds0 %>%
  select(starts_with("percent_working")) %>% 
  pivot_longer(cols = everything(),names_to = "measure",values_to="value") %>% 
  mutate( 
    measure = factor(measure,
                        levels = c("percent_working_march","percent_working_now")
                        ,labels = c("Pecent of stuff working in March 2022",
                                    "Pecent of stuff working as of now")
                        )
  ) %>% 
  ggplot(aes(x=value))+
  geom_histogram(binwidth = 100, alpha = .5, breaks=c(10,20,30,40,50,60,70,80,90,100))+
  facet_wrap("measure",ncol =5)
g
g %>%  quick_save("score-distribution",w=4, h=6)
```

```{r comm-between-hromadas-1, fig.height=3, fig.width=9,class.source="fold-hide"}
(ds0 %>% 
   filter(!is.na(commun_between_hromadas)) %>%
  mutate(
    `Frequency of communication with other hromadas` = fct_recode(
      commun_between_hromadas,
       "Daily"      = "Daily"
      ,"Several times a week"       = "Several times a week"
      ,"Several times a month" = "Several times a month"
      ,"Once a month and less" = "Once a month and less"
      ,"No meetings/calls" = "No meetings/calls"
    ) %>% factor( levels = c(
       "Daily"           
       ,"Several times a week"
       ,"Several times a month"
       ,"Once a month and less"
       ,"No meetings/calls"
    )
    )
  ) %>% 
  make_bi_freq_graph("military_action","Frequency of communication with other hromadas") )+
  labs(
    title = "Frequency of communication with representatives of other hromadas"
    ,x = NULL
  )
```

# 6. Evacuation
```{r evacuation, fig.height=3, fig.width=9,class.source="fold-hide"}
(ds0 %>% 
  mutate(
    `Need of evacuation among hromadas` = fct_recode(
      evacuation,
       "No need"      = "no"
      ,"Yes, and executed the evacuation"       = "yes_executed"
      ,"Yes, but did not manage to execute the evacuation" = "yes_notexecuted"
    ) %>% factor( levels = c(
       "No need"           
       ,"Yes, and executed the evacuation"
       ,"Yes, but did not manage to execute the evacuation"
    )
    )
  ) %>% 
  make_bi_freq_graph("military_action","Need of evacuation among hromadas") )+
  labs(
    title = "Need of evacuation among hromadas"
    ,x = NULL
  )
```
# 7. IDP

# 8. Economics

```{r special-fund-1, fig.height=3, fig.width=9,class.source="fold-hide"}
(ds0 %>% 
  mutate(
    `Special fund's expenditures were relocated` = fct_recode(
      special_fund_relocation,
       "Yes"      = "yes"
      ,"No"       = "no"
    ) %>% factor( levels = c(
       "Yes"           
       ,"No"     
    )
    )
  ) %>% 
  make_bi_freq_graph("military_action","Special fund's expenditures were relocated") )+
  labs(
    title = "Were budget expenditures from the special fund streamed to finance other, current needs?"
    ,x = NULL
  )
```

```{r special-fund-no-combat, fig.height=3, fig.width=9,class.source="fold-hide"}
(ds0 %>% filter(military_action=="no_combat") %>%
  mutate(
    `Special fund's expenditures were relocated` = case_when(special_fund_relocation=="no"~0,
                                                             special_fund_relocation=="yes"~1)
  ) %>% 
  ggplot(aes(x = prep_count, y = `Special fund's expenditures were relocated`)) +
  geom_point() +
  geom_smooth(method = "lm", se=F) +
  theme_bw() +
  labs(title = 'Relation between preparation and special fund realocation for non-combat hromadas') +
  xlab("counted preparations"))
```

```{r special-fund-urbanisation, fig.height=3, fig.width=9,class.source="fold-hide"}
(ds0 %>% filter(military_action=="no_combat") %>%
  mutate(
    `Special fund's expenditures were relocated` = case_when(special_fund_relocation=="no"~0,
                                                             special_fund_relocation=="yes"~1)
  ) %>% 
  ggplot(aes(x = urban_pct, y = `Special fund's expenditures were relocated`)) +
  geom_point() +
  geom_smooth(method = "lm", se=F) +
  theme_bw() +
  labs(title = 'Relation between urbanisation and special fund realocation for non-combat hromadas') +
  xlab("share of urban population"))
```

```{r special-fund-own-income, fig.height=3, fig.width=9,class.source="fold-hide"}
(ds0 %>% filter(military_action=="no_combat") %>%
  mutate(
    `Special fund's expenditures were relocated` = case_when(special_fund_relocation=="no"~0,
                                                             special_fund_relocation=="yes"~1)
  ) %>% 
  ggplot(aes(x = own_income_prop_2021, y = `Special fund's expenditures were relocated`)) +
  geom_point() +
  geom_smooth(method = "lm", se=F) +
  theme_bw() +
  labs(title = 'Relation between financial autonomy and special fund realocation for non-combat hromadas') +
  xlab("share of own revenue in total budget in 2021"))
```

```{r special-fund-sectors, fig.height=3, fig.width=9,class.source="fold-hide"}
ds0 %>% 
  filter(special_fund_relocation == "yes") %>% 
  select(hromada_name, `special_fund_relocation_needs/state_functions`:`special_fund_relocation_needs/healthcare`) %>% 
  pivot_longer(-c(hromada_name), names_to = "sector", values_to = "cut") %>% 
  mutate(
    sector = str_to_title(str_remove(sector, "sectors_"))
  ) %>% 
  group_by(sector) %>% 
  summarise(`Number of Hromadas` = sum(cut), .groups = "drop") %>% 
  filter(`Number of Hromadas` > 0)  %>% 
 mutate(sector = case_when(sector=="Special_fund_relocation_needs/Defense"~"Defense",
                           sector=="Special_fund_relocation_needs/Economic_activity"~"Economic Activity",
                           sector=="Special_fund_relocation_needs/Education"~"Education",
                           sector=="Special_fund_relocation_needs/Environment"~"Environment",
                           sector=="Special_fund_relocation_needs/Healthcare"~"Healthcare",
                           sector=="Special_fund_relocation_needs/Social_protection"~"Social Protection",
                           sector=="Special_fund_relocation_needs/Spirit_development"~"Spirit Development",
                           sector=="Special_fund_relocation_needs/State_functions"~"State Functions",
                           sector=="Special_fund_relocation_needs/Utilities"~"Utilities",
                           sector=="Special_fund_relocation_needs/Public_order"~"Public Order",
                           TRUE~sector)
 ) %>%
  ggplot(aes(x = `Number of Hromadas`, y = fct_reorder(sector, `Number of Hromadas`))) +
  geom_bar(stat = "identity", fill = "blue") +
  theme_bw()+
  labs(
    title = "Sectors for which the funds of the special fund were redistributed"
    ,subtitle = "Data were collected during October-November of 2022"
    ,y = "Sector"
  )+
  geom_col(position = position_stack()
           , alpha = .5
           ,data =
  )
```

```{r relocated-bussiness, fig.height=3, fig.width=9, class.source="fold-hide"}
ds0 %>% 
  mutate(relocated_companies = as.numeric(relocated_companies_text)) %>%
      group_by(region_en,  oblast_name_en ) %>% 
      summarize(`Relocated companies` = sum(relocated_companies, na.rm = TRUE)) %>% 
  filter(`Relocated companies`>0) %>%
    ggplot(aes(x = `Relocated companies`, y = fct_reorder(oblast_name_en, `Relocated companies`))) +
  geom_bar(stat = "identity", fill = "blue") +
  theme_bw()+
  labs(
    title = "Relocated businesses by destination region"
    ,subtitle = "Data were collected during October-November of 2022"
    ,y = "Oblast"
  )+
  geom_col(position = position_stack()
           , alpha = .5
           ,data =
  )
```

```{r relocated-companies-own-income, class.source="fold-hide"}
ds0 %>% 
  mutate(relocated_companies = as.numeric(relocated_companies_text)) %>% 
  filter(relocated_companies>0) %>%
    ggplot(aes(y = relocated_companies, x = own_income_prop_2021 )) +
  geom_point() +
  geom_smooth(method = "lm", se=F) +
  theme_bw() +
  labs(title = 'Relation between financial autonomy and business relocation inflow') +
  xlab("share of own revenue in total budget in 2021")
  
```

```{r relocated-companies-preparation, class.source="fold-hide"}
ds0 %>% filter(military_action=="no_combat") %>%
  mutate(relocated_companies = as.numeric(relocated_companies_text)) %>% 
  filter(relocated_companies>0) %>%
    ggplot(aes(y = relocated_companies, x = prep_count )) +
  geom_point() +
  geom_smooth(method = "lm", se=F) +
  theme_bw() +
  labs(title = 'Relation between preparations and business relocation inflow')
  
```

```{r created-jobs, fig.height=3, fig.width=9,class.source="fold-hide"}
(ds0 %>% 
   mutate(
    `Jobs created` = fct_recode(
      created_jobs,
       "Don't know" = "dk",
      "0-50" = "0_50_jobs",
      "51-100" = "51_100_jobs",
      "101-250" = "101_250_jobs"
    ) %>% factor( levels = c(
       "Don't know"           
       ,"0-50" ,
       "51-100",
       "101-250"
    )
    )
  ) %>%
   make_bi_freq_graph("Jobs created"))+
  labs(
    title = "How many jobs were created in the hromada thanks to the relocated enterprises?"
    ,subtitle = "Data were collected during October-November of 2022"
    ,y = NULL
  )
```

```{r bussiness-stimules, fig.height=3, fig.width=9,class.source="fold-hide"}
ds0 %>% filter(bussiness_stimules_none == 0) %>%
  select(hromada_name, `bussiness_stimules/tax_benefits`:`bussiness_stimules/other`) %>% 
  pivot_longer(-c(hromada_name), names_to = "type", values_to = "done") %>% 
  mutate(
    type = str_to_title(str_remove(type, "types_"))
  ) %>% 
  group_by(type) %>% 
  summarise(`number of hromadas` = sum(done), .groups = "drop") %>% 
  filter(`number of hromadas`>0) %>% 
  mutate(type = case_when(type == "Bussiness_stimules/Education" ~ "Organized Educational Events",
                          type == "Bussiness_stimules/Free_rooms" ~ "Provided Premises for Free",
                          type == "Bussiness_stimules/Tax_benefits" ~ "Provided with Tax Benefits",
                          type == "Bussiness_stimules/Other" ~ "Other Methods",
  TRUE~type)
  ) %>%
  ggplot(aes(x = `number of hromadas`, y = fct_reorder(type, `number of hromadas`))) +
  geom_bar(stat = "identity", fill = "blue") +
  theme_bw()+
  geom_col(position = position_stack()
           , alpha = .5
           ,data =
  )+
  labs(
    title = "Which incentives have been used to support business in the community since February 24?"
    ,x = "Number of Hromadas", y = NULL, fill = NULL
  )+
  theme(
    panel.grid.major.y  = element_blank()
    ,panel.border = element_blank()
    ,panel.grid.major.x = element_line(color = "black")
  )
```

# 9. Humanitarian

# 10. Reconstructioin

# small number of answers (38) - omit at this stage

## 10.1 Demage Evaluation

```{r damage-1, fig.height=3, fig.width=9, class.source="fold-hide"}
ds0 %>% 
  count(region_en, is_damaged) %>% 
  ggplot(aes(x = region_en, y = n, fill = is_damaged)) +
  geom_bar(stat = "identity") +
  labs(
    title = "Were there any destructions in the hromada as a result of military actions?"
    ,y = "Number of Hromadas", x = NULL, fill = NULL
  ) +
  theme_bw()

```



# 11. Current Challenges

```{r school-shelters, fig.height=3, fig.width=9, class.source="fold-hide"}
# ds0 %>% 
#   count(region_en, is_damaged) %>% 
#   ggplot(aes(x = region_en, y = n, fill = is_damaged)) +
#   geom_bar(stat = "identity") +
#   labs(
#     title = "Were there any destructions in the community as a result of military actions?"
#     ,y = "Number of Hromadas", x = NULL, fill = NULL
#   ) +
#   theme_bw()

```

#poor quality of answerts regarding days without schooling - consider to omit at all

## 11.1 Heating season

```{r heating-1, fig.height=3, fig.width=9, class.source="fold-hide"}
ds1_winter_prep %>% 
  select(hromada_name, all_of(prep_for_winter)) %>% 
  pivot_longer(
    -hromada_name
    ,names_to = "action"
    ,values_to = "response"
  ) %>% 
  group_by(action) %>% 
  summarise(n = sum(response, na.rm = T), .groups = "drop") %>% 
  ggplot(aes(x = n, y = fct_reorder(action, n))) +
  geom_bar(stat = "identity", fill = "blue") +
  labs(
    title = "Which of the following measures were implemented to prepare hromada for the heating season?"
    ,y = NULL, x = NULL, fill = NULL
  ) +
  theme_bw()
```

```{r heating-2, fig.height=3, fig.width=9, class.source="fold-hide"}
ds1_winter_prep %>% 
  count(winter_prep_count) %>% 
  filter(!is.na(winter_prep_count)) %>% 
  ggplot(aes(x = factor(winter_prep_count), y = n)) +
  geom_bar(stat = "identity", fill = "blue") +
  labs(
    title = "Number of measures implemented to prepare hromada for the heating season"
    ,y = "Number of hromadas", x = "Number of measures", fill = NULL
  ) +
  xlab("winter_prep_count")
```

```{r heating-models, results = "asis", class.source="fold-hide"}

m1_heating <-lm(data = ds1_winter_prep, 
       winter_prep_count ~ log(income_total_2021) + own_income_prop_2021 + 
         type + square + log(total_population_2022) + urban_pct + n_settlements + region_en + occupation + military_action + voluntary)

m2_heating <-lm(data = ds1_winter_prep, 
             winter_prep_count ~ log(income_total_2021) + own_income_prop_2021 + 
               turnout_2020 + travel_time +
               type + square + log(total_population_2022) + urban_pct + n_settlements + region_en + occupation + military_action + voluntary)

m3_heating <-lm(data = ds1_winter_prep,
             winter_prep_count ~ log(income_total_2021) + own_income_prop_2021 +
               turnout_2020 + + travel_time +
               type + square + log(total_population_2022) + urban_pct + n_settlements + region_en + occupation + military_action + voluntary +
               sex_head + age_head + education_head + incumbent + rda)

m4_heating <-lm(data = ds1_winter_prep,
             winter_prep_count ~ log(income_total_2021) + own_income_prop_2021 +
               turnout_2020 + + travel_time +
               type + square + log(total_population_2022) + urban_pct + n_settlements + region_en + occupation + military_action + voluntary +
               sex_head + age_head + education_head + incumbent + rda +
               youth_councils + youth_centers + region_en * sum_osbb_2020)


stargazer::stargazer(m1_heating, m2_heating, m3_heating, m4_heating, single.row = T, type = 'html')

```

## 11.2 Problem Involvement
```{r problem-models, fig.height=3, fig.width=9, class.source="fold-hide"}
m1_problem <-glm(data = ds1_problem, 
             hromada_exp ~ log(income_total_2021) + own_income_prop_2021 + 
             type + square + log(total_population_2022) + urban_pct + n_settlements + region_en + occupation + military_action + voluntary,
             family = "binomial")

m2_problem  <-glm(data = ds1_problem, 
             hromada_exp ~ log(income_total_2021) + own_income_prop_2021 + 
               turnout_2020 + travel_time +
               type + square + log(total_population_2022) + urban_pct + n_settlements + region_en + occupation + military_action + voluntary,
             family = "binomial")

m3_problem  <-glm(data = ds1_problem,
             hromada_exp ~ log(income_total_2021) + own_income_prop_2021 +
               turnout_2020 + + travel_time +
               type + square + log(total_population_2022) + urban_pct + n_settlements + region_en + occupation + military_action + voluntary +
               sex_head + age_head + education_head + incumbent + rda,
             family = "binomial")

m4_problem  <-glm(data = ds1_problem,
             hromada_exp ~ log(income_total_2021) + own_income_prop_2021 +
               turnout_2020 + + travel_time +
               type + square + log(total_population_2022) + urban_pct + n_settlements + region_en + occupation + military_action + voluntary +
               sex_head + age_head + education_head + incumbent + rda +
               youth_councils + youth_centers + region_en * sum_osbb_2020,
             family = "binomial")

stargazer::stargazer(m1_problem, m2_problem, m3_problem, m4_problem, single.row = T, type = 'html')


```

```{r}
meta_survey %>% filter(group=="preparation") %>% pull(name)


```

# Session Information {#session-info}

For the sake of documentation and reproducibility, the current report was rendered in the following environment. Click the line below to expand.

<details>

<summary>Environment </summary>

```{r session-info, echo=FALSE}
if( requireNamespace("devtools", quietly = TRUE) ) {
  devtools::session_info()
    } else {
      sessionInfo()
    }
```

</details>

```{r session-duration, echo=FALSE}
    report_render_duration_in_seconds <- round(as.numeric(difftime(Sys.time(), report_render_start_time, units="secs")))
```

Report rendered by `r Sys.info()["user"]` at `r strftime(Sys.time(), "%Y-%m-%d, %H:%M %z")` in `r report_render_duration_in_seconds` seconds.
